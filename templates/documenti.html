{% extends "base.html" %}

{% block title %}Documenti{% endblock %}

{% block content %}
<div class="content-card">
    <h2>ğŸ“ Tutti i Documenti Caricati</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Visualizza e gestisci tutti i preventivi e purchase order caricati nel sistema.
    </p>
    
    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <select id="filterType" onchange="filterDocuments()" style="padding: 10px; border-radius: 6px; border: 2px solid #e0e0e0;">
            <option value="all">Tutti i documenti</option>
            <option value="preventivo">Solo Preventivi</option>
            <option value="purchase_order">Solo Purchase Orders</option>
        </select>
        
        <input type="text" id="searchBox" placeholder="ğŸ” Cerca per pratica, targa, PO..." 
               onkeyup="filterDocuments()" 
               style="flex: 1; min-width: 250px; padding: 10px; border-radius: 6px; border: 2px solid #e0e0e0;">
        
        {% if documents|length > 0 %}
        <button class="btn btn-danger" onclick="clearAll()">
            ğŸ—‘ï¸ Elimina Tutto
        </button>
        {% endif %}
    </div>
    
    {% if documents|length > 0 %}
    <div id="documentsTable">
        <table>
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Filename</th>
                    <th>Pratica Hertz</th>
                    <th>PO Number</th>
                    <th>Targa</th>
                    <th>Totale</th>
                    <th>Data Caricamento</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr class="doc-row" 
                    data-type="{{ doc.type }}" 
                    data-search="{{ (doc.pratica_hertz or '') }} {{ (doc.po_number or '') }} {{ (doc.targa or '') }} {{ doc.filename }}">
                    <td>
                        {% if doc.type == 'preventivo' %}
                        <span class="badge badge-primary">ğŸ“„ Preventivo</span>
                        {% else %}
                        <span class="badge badge-success">ğŸ“‹ PO</span>
                        {% endif %}
                    </td>
                    <td style="font-size: 0.85em;">{{ doc.filename }}</td>
                    <td><strong>{{ doc.pratica_hertz or '-' }}</strong></td>
                    <td>{{ doc.po_number or '-' }}</td>
                    <td>{{ doc.targa or '-' }}</td>
                    <td>
                        {% if doc.totale %}
                        â‚¬ {{ "%.2f"|format(doc.totale) }}
                        {% elif doc.total %}
                        â‚¬ {{ "%.2f"|format(doc.total) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="font-size: 0.85em;">
                        {{ doc.data_caricamento[:10] if doc.data_caricamento else '-' }}
                    </td>
                    <td>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9em;" 
                                onclick="deleteDoc('{{ doc.type }}', '{{ doc.id }}')">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        <h3>Nessun documento caricato</h3>
        <p style="margin-top: 10px;">
            Carica preventivi e purchase order dalla dashboard per iniziare.
        </p>
        <a href="/" class="btn" style="margin-top: 20px; display: inline-block; text-decoration: none;">
            â¡ï¸ Vai alla Dashboard
        </a>
    </div>
    {% endif %}
</div>

<div class="content-card" style="background: #fff8e1; border-left: 4px solid #ffa726;">
    <h2>ğŸ”“ Sblocca Documenti GiÃ  Fatturati</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Se hai bisogno di riassociare documenti giÃ  fatturati (es: fattura sbagliata), 
        inserisci il numero di <strong>Pratica Hertz</strong> e clicca "Sblocca".
        Questo eliminerÃ  la fattura generata e ti permetterÃ  di riassociare i documenti.
    </p>
    
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" 
               id="praticaSblocco" 
               placeholder="es: 1526779" 
               style="flex: 1; min-width: 200px; padding: 12px; border-radius: 6px; border: 2px solid #e0e0e0; font-size: 16px;">
        
        <button class="btn" 
                style="background: #ffa726; padding: 12px 24px;" 
                onclick="sbloccaPratica()">
            ğŸ”“ Sblocca Pratica
        </button>
    </div>
    
    <div id="sbloccoResults" style="margin-top: 15px;"></div>
    
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; font-size: 0.9em;">
        <strong>âš ï¸ Attenzione:</strong><br>
        â€¢ Questa azione elimina la fattura XML generata<br>
        â€¢ I documenti (preventivo e PO) restano nel sistema<br>
        â€¢ Potrai riassociarli e rigenerare la fattura<br>
        â€¢ La numerazione NON viene modificata (mantiene il buco)
    </div>
</div>

<div class="content-card">
    <h2>ğŸ“Š Statistiche Documenti</h2>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>ğŸ“„ Preventivi</h3>
            <div class="number">{{ stats.preventivi }}</div>
        </div>
        
        <div class="stat-card">
            <h3>ğŸ“‹ Purchase Orders</h3>
            <div class="number">{{ stats.po }}</div>
        </div>
        
        <div class="stat-card">
            <h3>ğŸ“ Totale Documenti</h3>
            <div class="number">{{ documents|length }}</div>
        </div>
        
        <div class="stat-card">
            <h3>âœ… Associazioni</h3>
            <div class="number">{{ stats.lavori_pronti }}</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterDocuments() {
    const filterType = document.getElementById('filterType').value;
    const searchText = document.getElementById('searchBox').value.toLowerCase();
    const rows = document.querySelectorAll('.doc-row');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const type = row.getAttribute('data-type');
        const searchData = row.getAttribute('data-search').toLowerCase();
        
        const typeMatch = filterType === 'all' || type === filterType;
        const searchMatch = searchText === '' || searchData.includes(searchText);
        
        if (typeMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Mostra messaggio se nessun risultato
    const table = document.getElementById('documentsTable');
    const existingMsg = document.getElementById('noResultsMsg');
    
    if (existingMsg) {
        existingMsg.remove();
    }
    
    if (visibleCount === 0 && rows.length > 0) {
        const msg = document.createElement('div');
        msg.id = 'noResultsMsg';
        msg.className = 'alert alert-warning';
        msg.style.marginTop = '20px';
        msg.textContent = 'Nessun documento corrisponde ai filtri selezionati.';
        table.appendChild(msg);
    }
}

function deleteDoc(type, id) {
    if (!confirm('Eliminare questo documento?')) {
        return;
    }
    
    fetch(`/delete/${type}/${id}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Documento eliminato');
            setTimeout(() => location.reload(), 1000);
        } else {
            showError('Errore durante l\'eliminazione');
        }
    })
    .catch(error => {
        showError('Errore: ' + error);
    });
}

function clearAll() {
    if (!confirm('ATTENZIONE: Eliminare TUTTI i documenti?\n\nQuesta azione non puÃ² essere annullata!')) {
        return;
    }
    
    if (!confirm('Sei davvero sicuro? Tutti i preventivi e purchase order saranno eliminati.')) {
        return;
    }
    
    fetch('/clear-all', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Tutti i documenti sono stati eliminati');
            setTimeout(() => location.reload(), 1500);
        } else {
            showError('Errore durante l\'eliminazione');
        }
    })
    .catch(error => {
        showError('Errore: ' + error);
    });
}

function sbloccaPratica() {
    const pratica = document.getElementById('praticaSblocco').value.trim();
    const resultsDiv = document.getElementById('sbloccoResults');
    
    if (!pratica) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">âš ï¸ Inserisci il numero di pratica Hertz</div>';
        return;
    }
    
    if (!confirm(`Vuoi sbloccare la pratica ${pratica}?\n\nQuesta azione:\nâœ— Elimina la fattura generata\nâœ— Permette di riassociare i documenti\nâœ— NON modifica la numerazione\n\nContinuare?`)) {
        return;
    }
    
    resultsDiv.innerHTML = '<div class="alert alert-info">â³ Sblocco in corso...</div>';
    
    fetch(`/sblocca-pratica/${pratica}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `<div class="alert alert-success">âœ… ${data.message}</div>`;
            document.getElementById('praticaSblocco').value = '';
            showSuccess(data.message);
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">âŒ ${data.error}</div>`;
            showError(data.error);
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">âŒ Errore: ${error}</div>`;
        showError('Errore durante lo sblocco');
    });
}
</script>
{% endblock %}
