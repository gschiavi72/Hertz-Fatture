{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card" onclick="showDetails('preventivi')" style="cursor: pointer; transition: all 0.3s;">
        <h3>üìÑ Preventivi Caricati</h3>
        <div class="number">{{ stats.preventivi }}</div>
        <small style="color: #999; margin-top: 10px; display: block;">Clicca per vedere dettagli</small>
    </div>
    
    <div class="stat-card" onclick="showDetails('po')" style="cursor: pointer; transition: all 0.3s;">
        <h3>üìã Purchase Orders</h3>
        <div class="number">{{ stats.po }}</div>
        <small style="color: #999; margin-top: 10px; display: block;">Clicca per vedere dettagli</small>
    </div>
    
    <div class="stat-card" onclick="window.location.href='/lavori'" style="cursor: pointer; transition: all 0.3s;">
        <h3>‚úÖ Lavori Pronti</h3>
        <div class="number">{{ stats.lavori_pronti }}</div>
        <small style="color: #999; margin-top: 10px; display: block;">Clicca per generare fatture</small>
    </div>
    
    <div class="stat-card" onclick="showDetails('fatture')" style="cursor: pointer; transition: all 0.3s;">
        <h3>üìß Fatture Generate</h3>
        <div class="number">{{ stats.ordini_inviati }}</div>
        <small style="color: #999; margin-top: 10px; display: block;">Clicca per vedere storico</small>
    </div>
</div>

<!-- Modal per visualizzare i dettagli -->
<div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 50px auto; background: white; border-radius: 15px; padding: 30px; position: relative;">
        <button onclick="closeModal()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1.2em; font-weight: bold;">‚úï</button>
        <div id="modalContent"></div>
    </div>
</div>

<div class="content-card">
    <h2>üì§ Carica Documenti</h2>
    
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept=".pdf" multiple onchange="uploadFiles()">
        <h3 style="color: #667eea; margin-bottom: 10px;">üìÅ Trascina qui i file PDF</h3>
        <p style="color: #999;">oppure clicca per selezionare</p>
        <p style="color: #999; margin-top: 10px; font-size: 0.9em;">Supportati: Preventivi e Purchase Orders</p>
    </div>
    
    <div id="uploadResults"></div>
</div>

<div class="content-card">
    <h2>üìß Controllo Email Automatico</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Scarica automaticamente i Purchase Order dalla casella email configurata.
    </p>
    
    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="btn btn-success" onclick="checkEmail()">
            üì• Controlla Email (Ultimi 7 giorni)
        </button>
        <button class="btn btn-warning" onclick="checkEmailFrom()">
            üìÖ Controlla da Data Specifica
        </button>
    </div>
    
    <div id="emailResults"></div>
</div>

{% if stats.lavori_pronti > 0 %}
<div class="content-card">
    <h2>‚ö° Azioni Rapide</h2>
    <p style="margin-bottom: 20px; color: #666;">
        Hai <strong>{{ stats.lavori_pronti }} lavori</strong> pronti per generare la fattura.
    </p>
    <a href="/lavori" class="btn btn-success">
        ‚û°Ô∏è Vai ai Lavori Pronti
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) return;
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('file', files[i]);
    }
    
    showLoading('uploadResults');
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        let html = '<div style="margin-top: 20px;">';
        
        if (data.results && data.results.length > 0) {
            html += '<h3 style="color: #28a745; margin-bottom: 15px;">‚úÖ File Caricati</h3>';
            html += '<table><thead><tr><th>File</th><th>Tipo</th><th>Targa</th><th>Pratica</th><th>PO</th></tr></thead><tbody>';
            
            data.results.forEach(r => {
                const rowClass = r.gia_fatturato ? 'style="background: #fff3cd;"' : '';
                html += `<tr ${rowClass}>
                    <td>${r.filename}</td>
                    <td><span class="badge badge-${r.type === 'preventivo' ? 'primary' : 'success'}">${r.type}</span></td>
                    <td>${r.targa || '-'}</td>
                    <td>${r.pratica || '-'}</td>
                    <td>${r.po_number || '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // Aggiorna le statistiche
            if (data.stats) {
                updateStats(data.stats);
            }
            
            showSuccess(`${data.results.length} file caricati con successo!`);
        } else {
            html += '<p class="alert alert-warning">Nessun file valido caricato</p>';
        }
        
        html += '</div>';
        document.getElementById('uploadResults').innerHTML = html;
        fileInput.value = '';
    })
    .catch(error => {
        showError('Errore durante il caricamento: ' + error);
        document.getElementById('uploadResults').innerHTML = '';
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG AND DROP - Blocca apertura file nel browser
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', function() {
    const uploadZone = document.querySelector('.upload-zone');
    const fileInput = document.getElementById('fileInput');
    
    // BLOCCA completamente drag&drop su TUTTA la finestra
    window.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'none';
    }, false);
    
    window.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
    }, false);
    
    // Gestione SOLO sulla zona di upload
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'copy';
        uploadZone.style.borderColor = '#667eea';
        uploadZone.style.backgroundColor = '#f0f4ff';
        uploadZone.style.transform = 'scale(1.02)';
    }, false);
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.style.borderColor = '#e0e0e0';
        uploadZone.style.backgroundColor = '#f9fafb';
        uploadZone.style.transform = 'scale(1)';
    }, false);
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        uploadZone.style.borderColor = '#e0e0e0';
        uploadZone.style.backgroundColor = '#f9fafb';
        uploadZone.style.transform = 'scale(1)';
        
        const files = e.dataTransfer.files;
        
        if (files.length > 0) {
            // Crea un nuovo DataTransfer per assegnare i file all'input
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < files.length; i++) {
                if (files[i].type === 'application/pdf') {
                    dataTransfer.items.add(files[i]);
                }
            }
            fileInput.files = dataTransfer.files;
            uploadFiles();
        }
    }, false);
});

function checkEmail() {
    showLoading('emailResults');
    
    // Calcola data di 7 giorni fa
    const oggi = new Date();
    const setteGiorniFa = new Date(oggi);
    setteGiorniFa.setDate(oggi.getDate() - 7);
    
    // Formatta in YYYY/MM/DD (formato corretto per Gmail)
    const giorno = String(setteGiorniFa.getDate()).padStart(2, '0');
    const mese = String(setteGiorniFa.getMonth() + 1).padStart(2, '0');
    const anno = setteGiorniFa.getFullYear();
    const dataStr = `${anno}/${mese}/${giorno}`;
    
    fetch('/check-email', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ data_da: dataStr })
    })
    .then(response => response.json())
    .then(data => {
        displayEmailResults(data);
    })
    .catch(error => {
        showError('Errore durante il controllo email: ' + error);
        document.getElementById('emailResults').innerHTML = '';
    });
}

function checkEmailFrom() {
    const dataStr = prompt('Inserisci data di inizio (formato: GG/MM/AAAA):\n\nEsempio: 01/01/2026');
    
    if (!dataStr) return;
    
    // Converte GG/MM/AAAA ‚Üí YYYY/MM/DD per Gmail
    let dataConverted = dataStr.trim();
    const parts = dataConverted.split('/');
    if (parts.length === 3 && parts[2].length === 4) {
        dataConverted = `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    
    showLoading('emailResults');
    
    fetch('/check-email', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ data_da: dataConverted })
    })
    .then(response => response.json())
    .then(data => {
        displayEmailResults(data);
    })
    .catch(error => {
        showError('Errore durante il controllo email: ' + error);
        document.getElementById('emailResults').innerHTML = '';
    });
}

function displayEmailResults(data) {
    let html = '<div style="margin-top: 20px;">';
    
    if (data.error) {
        html += `<div class="alert alert-danger">${data.error}</div>`;
    } else {
        html += `<div class="alert alert-success">
            ‚úÖ Email controllate: ${data.checked}<br>
            üì• Nuovi PO scaricati: ${data.downloaded}<br>
            ‚è≠Ô∏è Duplicati saltati: ${data.duplicati}
        </div>`;
        
        if (data.files && data.files.length > 0) {
            html += '<h3 style="margin-top: 20px;">File Scaricati:</h3>';
            html += '<table><thead><tr><th>File</th><th>PO</th><th>Tipo</th><th>Mittente</th></tr></thead><tbody>';
            
            data.files.forEach(f => {
                html += `<tr>
                    <td>${f.filename}</td>
                    <td><strong>${f.po_number || '-'}</strong></td>
                    <td><span class="badge badge-success">${f.type}</span></td>
                    <td>${f.from}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
        }
        
        if (data.errors && data.errors.length > 0) {
            html += '<h3 style="margin-top: 20px; color: #dc3545;">Errori:</h3><ul>';
            data.errors.forEach(e => html += `<li>${e}</li>`);
            html += '</ul>';
        }
        
        if (data.downloaded > 0) {
            setTimeout(() => location.reload(), 2000);
        }
    }
    
    html += '</div>';
    document.getElementById('emailResults').innerHTML = html;
}

function updateStats(stats) {
    // Aggiorna i numeri nelle card
    document.querySelectorAll('.stat-card .number').forEach((el, idx) => {
        const values = [stats.preventivi, stats.po, stats.lavori_pronti, stats.ordini_inviati];
        el.textContent = values[idx];
    });
}

function showDetails(type) {
    const modal = document.getElementById('detailsModal');
    const content = document.getElementById('modalContent');
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Caricamento...</p></div>';
    modal.style.display = 'block';
    
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (type === 'preventivi') {
                html = generatePreventiviHTML(data);
            } else if (type === 'po') {
                html = generatePOHTML(data);
            } else if (type === 'fatture') {
                html = generateFattureHTML(data);
            }
            
            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = '<div class="alert alert-danger">Errore nel caricamento dei dati</div>';
        });
}

function generatePreventiviHTML(data) {
    return fetch('/api/stats')
        .then(response => response.json())
        .then(statsData => {
            let html = '<h2 style="color: #667eea; margin-bottom: 20px;">üìÑ Preventivi Caricati (' + data.preventivi + ')</h2>';
            
            // Carica la pagina documenti per ottenere i preventivi
            return fetch('/documenti')
                .then(response => response.text())
                .then(htmlText => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    
                    // Trova la tabella documenti
                    const table = doc.querySelector('table');
                    
                    if (table && data.preventivi > 0) {
                        // Crea una nuova tabella solo con i preventivi
                        html += '<table style="width: 100%; border-collapse: collapse;">';
                        html += '<thead><tr>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Filename</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Pratica</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Targa</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Totale</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Data</th>';
                        html += '</tr></thead><tbody>';
                        
                        // Trova tutte le righe che contengono preventivi
                        const rows = table.querySelectorAll('tbody tr');
                        let count = 0;
                        
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length > 0) {
                                const typeCell = cells[0];
                                // Controlla se √® un preventivo
                                if (typeCell.textContent.includes('Preventivo')) {
                                    count++;
                                    html += '<tr style="border-bottom: 1px solid #f0f0f0;">';
                                    html += '<td style="padding: 15px;">' + (cells[1] ? cells[1].textContent : '-') + '</td>';
                                    html += '<td style="padding: 15px;"><strong>' + (cells[2] ? cells[2].textContent : '-') + '</strong></td>';
                                    html += '<td style="padding: 15px;">' + (cells[4] ? cells[4].textContent : '-') + '</td>';
                                    html += '<td style="padding: 15px;"><strong>' + (cells[5] ? cells[5].textContent : '-') + '</strong></td>';
                                    html += '<td style="padding: 15px; font-size: 0.85em;">' + (cells[6] ? cells[6].textContent : '-') + '</td>';
                                    html += '</tr>';
                                }
                            }
                        });
                        
                        html += '</tbody></table>';
                        
                        if (count === 0) {
                            html += '<div class="alert alert-warning" style="margin-top: 20px;">Nessun preventivo trovato</div>';
                        }
                    } else {
                        html += '<div class="alert alert-warning">Nessun preventivo caricato</div>';
                    }
                    
                    html += '<div style="margin-top: 20px;">';
                    html += '<a href="/documenti" class="btn" style="text-decoration: none; display: inline-block;">üìÅ Vai alla pagina Documenti completa</a>';
                    html += '</div>';
                    
                    document.getElementById('modalContent').innerHTML = html;
                });
        });
}

function generatePOHTML(data) {
    return fetch('/api/stats')
        .then(response => response.json())
        .then(statsData => {
            let html = '<h2 style="color: #28a745; margin-bottom: 20px;">üìã Purchase Orders (' + data.po + ')</h2>';
            
            // Carica la pagina documenti per ottenere i PO
            return fetch('/documenti')
                .then(response => response.text())
                .then(htmlText => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    
                    // Trova la tabella documenti
                    const table = doc.querySelector('table');
                    
                    if (table && data.po > 0) {
                        // Crea una nuova tabella solo con i PO
                        html += '<table style="width: 100%; border-collapse: collapse;">';
                        html += '<thead><tr>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Filename</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Pratica</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">PO Number</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Targa</th>';
                        html += '<th style="background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid #e0e0e0;">Data</th>';
                        html += '</tr></thead><tbody>';
                        
                        // Trova tutte le righe che contengono PO
                        const rows = table.querySelectorAll('tbody tr');
                        let count = 0;
                        
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length > 0) {
                                const typeCell = cells[0];
                                // Controlla se √® un PO
                                if (typeCell.textContent.includes('PO')) {
                                    count++;
                                    html += '<tr style="border-bottom: 1px solid #f0f0f0;">';
                                    html += '<td style="padding: 15px;">' + (cells[1] ? cells[1].textContent : '-') + '</td>';
                                    html += '<td style="padding: 15px;"><strong>' + (cells[2] ? cells[2].textContent : '-') + '</strong></td>';
                                    html += '<td style="padding: 15px;"><strong>' + (cells[3] ? cells[3].textContent : '-') + '</strong></td>';
                                    html += '<td style="padding: 15px;">' + (cells[4] ? cells[4].textContent : '-') + '</td>';
                                    html += '<td style="padding: 15px; font-size: 0.85em;">' + (cells[6] ? cells[6].textContent : '-') + '</td>';
                                    html += '</tr>';
                                }
                            }
                        });
                        
                        html += '</tbody></table>';
                        
                        if (count === 0) {
                            html += '<div class="alert alert-warning" style="margin-top: 20px;">Nessun Purchase Order trovato</div>';
                        }
                    } else {
                        html += '<div class="alert alert-warning">Nessun Purchase Order caricato</div>';
                    }
                    
                    html += '<div style="margin-top: 20px;">';
                    html += '<a href="/documenti" class="btn" style="text-decoration: none; display: inline-block;">üìÅ Vai alla pagina Documenti completa</a>';
                    html += '</div>';
                    
                    document.getElementById('modalContent').innerHTML = html;
                });
        });
}

function generateFattureHTML(data) {
    return fetch('/configurazione')
        .then(response => response.text())
        .then(htmlText => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const table = doc.querySelector('table');
            
            let html = '<h2 style="color: #667eea; margin-bottom: 20px;">üìß Fatture Generate (' + data.ordini_inviati + ')</h2>';
            
            if (table) {
                html += table.outerHTML;
                
                // Inserisci HTML
                document.getElementById('modalContent').innerHTML = html;
                
                // Aggiungi event listener ai pulsanti esistenti (dopo che l'HTML √® nel DOM)
                setTimeout(() => {
                    const deleteButtons = document.querySelectorAll('#modalContent .btn-danger');
                    deleteButtons.forEach(btn => {
                        // Estrai il filename dall'onclick attribute
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr) {
                            const match = onclickAttr.match(/deleteFattura\('([^']+)'\)/);
                            if (match) {
                                const filename = match[1];
                                const row = btn.closest('tr');
                                
                                // Rimuovi il vecchio onclick e aggiungi nuovo event listener
                                btn.removeAttribute('onclick');
                                btn.onclick = () => deleteFatturaFromModal(filename, row);
                            }
                        }
                    });
                }, 50);
            } else {
                html += '<div class="alert alert-warning">Nessuna fattura generata</div>';
                document.getElementById('modalContent').innerHTML = html;
            }
        });
}

function deleteFatturaFromModal(filename, row) {
    if (!confirm('Eliminare questa fattura?\n\nFile: ' + filename + '\n\nQuesta azione non pu√≤ essere annullata!')) {
        return;
    }
    
    const originalHtml = row.innerHTML;
    row.innerHTML = '<td colspan="7" style="text-align: center;"><div class="spinner" style="display: inline-block; width: 30px; height: 30px;"></div> Eliminazione...</td>';
    
    fetch('/delete-fattura/' + encodeURIComponent(filename), {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('‚úÖ Fattura eliminata con successo!');
            row.remove();
            
            // Aggiorna il contatore
            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => {
                    updateStats(stats);
                    const header = document.querySelector('#modalContent h2');
                    if (header) {
                        header.textContent = 'üìß Fatture Generate (' + stats.ordini_inviati + ')';
                    }
                    
                    // Se non ci sono pi√π fatture, mostra messaggio
                    const tbody = document.querySelector('#modalContent table tbody');
                    if (tbody && tbody.querySelectorAll('tr').length === 0) {
                        document.getElementById('modalContent').innerHTML = 
                            '<h2 style="color: #667eea; margin-bottom: 20px;">üìß Fatture Generate (0)</h2>' +
                            '<div class="alert alert-warning">Nessuna fattura generata</div>';
                    }
                });
        } else {
            showError('‚ùå Errore durante l\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
            row.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        showError('‚ùå Errore: ' + error);
        row.innerHTML = originalHtml;
    });
}

function closeModal() {
    document.getElementById('detailsModal').style.display = 'none';
}

// Chiudi modal cliccando fuori
document.addEventListener('click', function(event) {
    const modal = document.getElementById('detailsModal');
    if (event.target === modal) {
        closeModal();
    }
});
</script>
{% endblock %}
